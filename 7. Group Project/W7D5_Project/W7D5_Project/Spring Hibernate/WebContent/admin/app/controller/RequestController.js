/*
 * File: app/controller/RequestController.js
 *
 * This file was generated by Sencha Architect version 3.1.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.0.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.0.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('W5D5_Project.controller.RequestController', {
    extend: 'Ext.app.Controller',

    id: 'requestController',

    control: {
        "#reqApproveBtn": {
            click: 'onReqApproveBtnClick'
        },
        "#reqRejectBtn": {
            click: 'onReqRejectBtnClick'
        },
        "#requestGrid": {
            selectionchange: 'onRequestGridChange'
        }
    },

    onReqApproveBtnClick: function() {
        var requestId,userEmail,userDate,requestStatus,request;

        requestId = Ext.getCmp('requestGrid').getSelectionModel().selected.items[0].data.requestId;
        userEmail = Ext.getCmp('requestGrid').getSelectionModel().selected.items[0].data.userEmail;
        userDate = Ext.getCmp('requestGrid').getSelectionModel().selected.items[0].data.userDate;

        request = {
            "requestId" : requestId,
            "userEmail" : userEmail,
            "userDate" : userDate,
            "requestStatus" : "APPROVED"
        };

        Ext.Ajax.request({
                            url : "updateRequest",
                            method: 'POST',
                            params : {
                                id : requestId,
                                email: userEmail,
                                date : userDate,
                                status : "APPROVED"
                            },
                            async: false,
                            callback : function(options, success, response){
                                if (Ext.isEmpty(response.responseText)) {
                                     Ext.Msg.alert("Request","Error in approving request");
                                } else {
                                     Ext.Msg.alert("Request","Success in approving request");
                                    Ext.Ajax.request({
                                        url : 'updateToPremium',
                                        method : 'POST',
                                        aync : false,
                                        params : {
                                            email : userEmail
                                        },
                                        callback : function(options, success, response){
                                            if(response.responseText===true){
                                                console.log('Success! ');
                                            }else{
                                                console.log('Failed! ');
                                            }
                                        }
                                     });
                                    Ext.Ajax.request({
                                        url : "getAllRequest",
                                        method : "GET",
                                        async : false,
                                        callback : function(options,success,response){
                                            if (Ext.isEmpty(response.responseText)) {
                                                Ext.Msg.alert("Requests", "Error in getting requests");
                                            } else {
                                                var reqStore = Ext.getStore('RequestStore');
                                                var jsonResponse = Ext.JSON.decode(response.responseText);
                                                reqStore.loadData(jsonResponse);
                                            }
                                        }
                                    });
                                   Ext.getCmp('requestGrid').getView().refresh();
                                }
                            }
                        });
        Ext.getCmp('reqFirstName').setValue('');
        Ext.getCmp('reqLastName').setValue('');
        Ext.getCmp('reqAddress1').setValue('');
        Ext.getCmp('reqAddress2').setValue('');
        Ext.getCmp('reqCountry').setValue('');
        Ext.getCmp('reqSp').setValue('');
        Ext.getCmp('reqCity').setValue('');
        Ext.getCmp('reqOccupation').setValue('');
        Ext.getCmp('reqEmail').setValue('');
    },

    onReqRejectBtnClick: function() {
        var requestId,userEmail,userDate,requestStatus,request;

        requestId = Ext.getCmp('requestGrid').getSelectionModel().selected.items[0].data.requestId;
        userEmail = Ext.getCmp('requestGrid').getSelectionModel().selected.items[0].data.userEmail;
        userDate = Ext.getCmp('requestGrid').getSelectionModel().selected.items[0].data.userDate;

        request = {
            "requestId" : requestId,
            "userEmail" : userEmail,
            "userDate" : userDate,
            "requestStatus" : "REJECTED"
        };

        Ext.Ajax.request({
                            url : "updateRequest",
                            method: 'POST',
                            params : {
                                id : requestId,
                                email: userEmail,
                                date : userDate,
                                status : "REJECTED"
                            },
                            async: false,
                            callback : function(options, success, response){
                                if (response.responseText=="false") {
                                     Ext.Msg.alert("Request","Error in rejecting request");
                                } else {
                                     Ext.Msg.alert("Request","Success in rejecting request");
                                    Ext.Ajax.request({
                                        url : "getAllRequest",
                                        method : "GET",
                                        async : false,
                                        callback : function(options,success,response){
                                            if (Ext.isEmpty(response.responseText)) {
                                                Ext.Msg.alert("Requests", "Error in getting requests");
                                            } else {
                                                var reqStore = Ext.getStore('RequestStore');
                                                var jsonResponse = Ext.JSON.decode(response.responseText);
                                                reqStore.loadData(jsonResponse);
                                            }
                                        }
                                    });
                                    Ext.getCmp('requestGrid').getView().refresh();
                                }
                            }
                        });
        Ext.getCmp('reqFirstName').setValue('');
        Ext.getCmp('reqLastName').setValue('');
        Ext.getCmp('reqAddress1').setValue('');
        Ext.getCmp('reqAddress2').setValue('');
        Ext.getCmp('reqCountry').setValue('');
        Ext.getCmp('reqSp').setValue('');
        Ext.getCmp('reqCity').setValue('');
        Ext.getCmp('reqOccupation').setValue('');
        Ext.getCmp('reqEmail').setValue('');
    },

    onRequestGridChange: function(model, selected, eOpts) {
        var user,selected;
                this.selected = selected;
                if(!Ext.isEmpty(selected[0])){
                    var gridEmail = selected[0].data.userEmail;
                    Ext.Ajax.request({
                    url : "getUserByEmail",
                    method: 'GET',
                    params : {
                        email: gridEmail
                    },
                    async: false,
                    callback : function(options, success, response){
                        if (Ext.isEmpty(response.responseText)) {
                             Ext.Msg.alert("Users","Error in getting Users");
                             console.log('Failed ');
                        } else {
                             console.log('Success! ');
                             user = Ext.JSON.decode(response.responseText);
                        }
                    }
                });
                Ext.getCmp('reqFirstName').setValue(user[0].userFname);
                Ext.getCmp('reqLastName').setValue(user[0].userLname);
                Ext.getCmp('reqAddress1').setValue(user[0].userAddress1);
                Ext.getCmp('reqAddress2').setValue(user[0].userAddress2);
                Ext.getCmp('reqCountry').setValue(user[0].userCountry);
                Ext.getCmp('reqSp').setValue(user[0].userSp);
                Ext.getCmp('reqCity').setValue(user[0].userCity);
                Ext.getCmp('reqOccupation').setValue(user[0].userOccupation);
                Ext.getCmp('reqEmail').setValue(user[0].userEmail);
                }
    }

});
